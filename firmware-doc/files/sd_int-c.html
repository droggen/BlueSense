<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>sd_int.c</title><link rel="stylesheet" type="text/css" href="../styles/main.css"><script type="text/javascript" src="../styles/main.js"></script><script type="text/javascript">NDLoader.LoadJS("Content", "../styles/");</script></head>

<!-- Generated by Natural Docs, version 2.0 (Development Release 08-22-2015) -->

<!-- saved from url=(0026)http://www.naturaldocs.org -->

<body onload="NDLoader.OnLoad('Content');" class="NDPage NDContentPage">

<a name="sd_int"></a><a name="Topic126"></a><div class="CTopic TFile LC first">
 <div class="CTitle">sd_int</div>
 <div class="CBody"><p>SD card internal functions.</p><p>This provides internal functions used to communicate with the SD card.</p><p>This library requires cards compatible with the Physical Spec version 2.00. This rules out some standard capacity SD cards and MMC cards.</p><p>As this library uses the Physical Spec Version 2.0 all card read/write operations must be done on entire sectors (512-bytes) and the address of read and write operations are given in sectors.</p><p><b>Notes on CRC</b></p><p>The CRC is only required for CMD0; once initialised the CRC is by default disabled, unless re-enabled.&nbsp; If disabled, the only constraint is that the CRC has the LSB set to 1 (e.g. CRC=0x01 is valid).</p><p><b>Notes on clocking</b></p><p>Some SD cards (e.g. Sandisk SDHC) require additional SPI clocks after and/or before commands to do some internal tasks.&nbsp; This is not documented in the the SD docs, but reported in multiple online experience reports and verified here as well.</p><p>Enabling MMCPRECLOCK works on all tested cards, but MMCPRECLOCK and MMCPOSTCLOCK only worked on few.</p><p>MMCPOSTCLOCK issues an 0xFF byte after an rn command (receiving 1 to n bytes in return).&nbsp; However if the command returns a block, the 0xFF byte can miss the start block token.&nbsp; We observed a Kingstong SDHC 16GB that returns the start block token on the first byte exchanged after the R1 answer, and a Kingston SDHC 8GB and Sandisk SDHC 32GB that returns the start block on the second byte exchanged after the R1 answer.</p><div class="CHeading">Therefore</div><ul><li><p>Do not send a postclock if the command receives a block answer</p></li><li><p>Or prefer to send a preclock and no postclock</p></li></ul><p><b>Internal low-level functions</b></p><ul><li><p>_sd_command_rn: 					DoSel, issue command, read n bytes answer, Desel</p></li><li><p>_sd_command_rn_ns:				NoSel, issue command, read n bytes answer</p></li><li><p>_sd_command_rn_retry:				Retries _sd_command_rn until desired answer or timeout and returns RN answer; computes crc</p></li><li><p>_sd_command_rn_retry_crc:			Retries _sd_command_rn until desired answer or timeout and returns RN answer; use provided crc</p></li><li><p>_sd_command_r1_retry:				Calls _sd_command_rn_retry with R1 answers</p></li><li><p>_sd_command_r1_retry_crc:			Calls _sd_command_rn_retry_crc with R1 answers</p></li><li><p>_sd_readblock_ns:					Waits for a start block token and reads a block answer and checksum</p></li><li><p>_sd_command_r1_datablock:			Sends a command giving an R1 answer followed by a block answer (CSD, CID, read data)</p></li><li><p>_sd_acommand_ns</p></li></ul><p><b>Internal block read/write</b></p><ul><li><p>_sd_block_open:					Selects the card and start a single block write command at the specified address</p></li><li><p>_sd_block_stop:					Call after 512 bytes are written to complete the block with the checksum and wait for readyness.</p></li><li><p>_sd_block_stop_nowait:			Completes a block write by sending the CRC and returns; does not wait for readyness.</p></li><li><p>_sd_block_stop_dowait:			Waits for readyness after a block write.</p></li><li><p>_sd_block_close:					Terminates the block write transaction and deselects the card.</p></li><li><p>_sd_writebuffer:					Writes size bytes from buffer to card.</p></li><li><p>_sd_writeconst:					Writes size times byte b to card.</p></li></ul><p><b>Internal multiblock read/write</b></p><ul><li><p>_sd_multiblock_open:			Selects the card and starts a multiblock write by sending the MMC_WRITE_MULTIPLE_BLOCK command.</p></li><li><p>_sd_multiblock_close: 		Terminates the multiblock write by sending MMC_STOPBLOCK and deselecting the card.</p></li></ul><p>Note that there is no internal &quot;_sd_multiblock write&quot; in this library; use _sd_writebuffer internally.</p><p>The following are the state variables: _sd_write_stream_open;									// Block open for writing (.ie. multiblock command send) _sd_write_stream_started								// Block is started (i.e. data token has been transmitted) _sd_write_stream_address;								// Address to write to</p><p><b>Dependencies</b></p><ul><li><p>spi</p></li><li><p>Card on SPI interface: this library assumes the card is interfaced on the SPI interface. The SPI interface must be initialised before using this library.</p></li></ul><p><b>Internal functions</b></p><ul><li><p>_sd_cmd9: 						Issue CMD9 to read CSD data.</p></li><li><p>_sd_cmd10: 						Issue CMD10 to read CID data.</p></li><li><p>_sd_cmd58							Issue CMD58 (read OCR) aka &quot;Extension Register Read Command&quot;</p></li></ul><p><b>Usage in interrupts</b> Not suitable for use in interrupts.</p><p><b>Possible improvements</b> Reduce or remove delay prior to command</p><p><b>TODO</b> - check streamcache block write clocks 0xFF during write when waiting for device to be free but buffer not full</p></div>
</div>

<a name="Functions"></a><a name="Topic79"></a><div class="CTopic TGroup LC">
 <div class="CTitle">Functions</div>
</div>

<a name="_sd_command_rn_retry"></a><a name="Topic48"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_command_rn_retry</div>
 <div id="NDPrototype48" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_command_rn_retry(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">cmd,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p1,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p2,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p3,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p4,</td></tr><tr><td class="first"></td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">response,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">n,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">answermask,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">okanswer</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Selects the SD card and sends a command, retrying if failure.&nbsp; Suitable for card answers different than R1.</p><p>This function computs the CRC which is required to issue a command internally.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">cmd<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Command to send to card</p></td></tr><tr><td class="CDLEntry">p1-p4</td><td class="CDLDefinition"><p>Parameters p1 to p4</p></td></tr><tr><td class="CDLEntry">crc</td><td class="CDLDefinition"><p>CRC of the command</p></td></tr><tr><td class="CDLEntry">response<div class="CDLParameterType"><span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Pointer to buffer receiving the card response</p></td></tr><tr><td class="CDLEntry">n<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">short</span></div></td><td class="CDLDefinition"><p>Number of response bytes</p></td></tr><tr><td class="CDLEntry">answermask<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>The card answer is masked with answermask before being compared with okanswer.&nbsp; When an exact answer is desired use answermask=0xff</p></td></tr><tr><td class="CDLEntry">okanswer<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Expected answer in case of success after masking with answermask.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_command_rn_retry_crc"></a><a name="Topic60"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_command_rn_retry_crc</div>
 <div id="NDPrototype60" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_command_rn_retry_crc(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">cmd,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p1,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p2,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p3,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p4,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">crc,</td></tr><tr><td class="first"></td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">response,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">n,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">answermask,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">okanswer</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Selects the SD card and sends a command, retrying if failure.&nbsp; Suitable for card answers different than R1.</p><p>Use this function if the crc of the command is known.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">cmd<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Command to send to card</p></td></tr><tr><td class="CDLEntry">p1-p4</td><td class="CDLDefinition"><p>Parameters p1 to p4</p></td></tr><tr><td class="CDLEntry">crc<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>CRC of the command</p></td></tr><tr><td class="CDLEntry">response<div class="CDLParameterType"><span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Pointer to buffer receiving the card response</p></td></tr><tr><td class="CDLEntry">n<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">short</span></div></td><td class="CDLDefinition"><p>Number of response bytes</p></td></tr><tr><td class="CDLEntry">answermask<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>The card answer is masked with answermask before being compared with okanswer.&nbsp; When an exact answer is desired use answermask=0xff</p></td></tr><tr><td class="CDLEntry">okanswer<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Expected answer in case of success after masking with answermask.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_command_r1_retry"></a><a name="Topic82"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_command_r1_retry</div>
 <div id="NDPrototype82" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_command_r1_retry(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">cmd,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p1,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p2,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p3,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p4,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">answermask,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">okanswer,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">r1</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Selects the SD card and sends a command, retrying if failure.&nbsp; Suitable for card answers R1.</p><p>This function computs the CRC which is required to issue a command internally.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">cmd<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Command to send to card</p></td></tr><tr><td class="CDLEntry">p1-p4</td><td class="CDLDefinition"><p>Parameters p1 to p4</p></td></tr><tr><td class="CDLEntry">answermask<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>The card answer is masked with answermask before being compared with okanswer.&nbsp; When an exact answer is desired use answermask=0xff</p></td></tr><tr><td class="CDLEntry">okanswer<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Expected answer in case of success after masking with answermask.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_command_r1_retry_crc"></a><a name="Topic83"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_command_r1_retry_crc</div>
 <div id="NDPrototype83" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_command_r1_retry_crc(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">cmd,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p1,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p2,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p3,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">p4,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">crc,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">answermask,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td></td><td class="PName last">okanswer,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">r1</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Selects the SD card and sends a command, retrying if failure.&nbsp; Suitable for card answers R1.</p><p>Use this function if the crc of the command is known.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">cmd<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Command to send to card</p></td></tr><tr><td class="CDLEntry">p1-p4</td><td class="CDLDefinition"><p>Parameters p1 to p4</p></td></tr><tr><td class="CDLEntry">crc<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>CRC of the command</p></td></tr><tr><td class="CDLEntry">answermask<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>The card answer is masked with answermask before being compared with okanswer.&nbsp; When an exact answer is desired use answermask=0xff</p></td></tr><tr><td class="CDLEntry">okanswer<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span></div></td><td class="CDLDefinition"><p>Expected answer in case of success after masking with answermask.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_waitblock_ns"></a><a name="Topic280"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_waitblock_ns</div>
 <div id="NDPrototype280" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_waitblock_ns(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Loops until the start token delimiting a block is encountered.</p><p>Does not select the card.</p><p>Return value: 0:				Success 1:				Error</p></div>
</div>

<a name="_sd_readblock_ns"></a><a name="Topic281"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_readblock_ns</div>
 <div id="NDPrototype281" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_readblock_ns(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="first"></td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">buffer,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">n,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">checksum</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Waits for a start block token and reads a block answer and checksum</p><p>n:		Number of data bytes to read (excluding the 2 bytes checksum, which are automatically read)</p><p>Does not select the card.</p><p>Return value: 0:				Success 1:				Error</p></div>
</div>

<a name="_sd_cmd9"></a><a name="Topic85"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_cmd9</div>
 <div id="NDPrototype85" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_cmd9(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="first"></td><td class="PType">CSD&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">csd,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">capacity_sector</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issue CMD9 to read CSD data.&nbsp; This function also parses the CSD data to return the card capacity in sectors.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">csd<div class="CDLParameterType">CSD*</div></td><td class="CDLDefinition"><p>Pointer to receive the CSD data</p></td></tr><tr><td class="CDLEntry">capacity_sector<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span>*</div></td><td class="CDLDefinition"><p>Pointer to receive the card capacity in sectors</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_cmd10"></a><a name="Topic86"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_cmd10</div>
 <div id="NDPrototype86" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_cmd10(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first">CID&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">cid</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issue CMD10 to read CID data.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">cid<div class="CDLParameterType">CID*</div></td><td class="CDLDefinition"><p>Pointer to receive the CID data</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_cmd32"></a><a name="Topic282"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_cmd32</div>
 <div id="NDPrototype282" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_cmd32(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PName last">addr</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issue CMD32, indicating the start sector of an erase command.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">addr<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span></div></td><td class="CDLDefinition"><p>Address in sectors with a card with Physical Spec Version 2.00 (blocks fixed to 512 bytes as in SDHC/SDXC)</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_cmd33"></a><a name="Topic283"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_cmd33</div>
 <div id="NDPrototype283" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_cmd33(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PName last">addr</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issue CMD33, indicating the end sector of an erase command.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">addr<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span></div></td><td class="CDLDefinition"><p>Address in sectors with a card with Physical Spec Version 2.00 (blocks fixed to 512 bytes as in SDHC/SDXC)</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_cmd38"></a><a name="Topic284"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_cmd38</div>
 <div id="NDPrototype284" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_cmd38(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issue CMD38, triggering an erase of all sectors between those indicated by _sd_cmd32 and _sd_cmd33.</p><p>On some cards, this function can take significant time to complete (tens of seconds).</p><div class="CHeading">Parameters</div><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_acmd13"></a><a name="Topic285"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_acmd13</div>
 <div id="NDPrototype285" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_acmd13(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first">SDSTAT&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">sdstat</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Selects the SD card and sends a command, retrying if failure.&nbsp; Suitable for card answers different than R1.</p><p>This function computs the CRC which is required to issue a command internally.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">sdstat<div class="CDLParameterType">SDSTAT*</div></td><td class="CDLDefinition"><p>Pointer to SDSTAT structure receiving data.</p></td></tr><tr><td class="CDLEntry">p1-p4</td><td class="CDLDefinition"><p>Parameters p1 to p4</p></td></tr><tr><td class="CDLEntry">crc</td><td class="CDLDefinition"><p>CRC of the command</p></td></tr><tr><td class="CDLEntry">response</td><td class="CDLDefinition"><p>Pointer to buffer receiving the card response</p></td></tr><tr><td class="CDLEntry">n</td><td class="CDLDefinition"><p>Number of response bytes</p></td></tr><tr><td class="CDLEntry">answermask</td><td class="CDLDefinition"><p>The card answer is masked with answermask before being compared with okanswer.&nbsp; When an exact answer is desired use answermask=0xff</p></td></tr><tr><td class="CDLEntry">okanswer</td><td class="CDLDefinition"><p>Expected answer in case of success after masking with answermask.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_acommand_ns"></a><a name="Topic286"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_acommand_ns</div>
 <div id="NDPrototype286" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_acommand_ns(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PName last">acmd,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PName last">p1,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PName last">p2,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PName last">p3,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PName last">p4</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issues an ACMD (sequence of CMD55 and ACMD), without selecting the card and reads a R1 answer.&nbsp; Does not select the card.</p><p>This function uses dummy CRC and only works if CRC checking is disabled.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">sdstat</td><td class="CDLDefinition"><p>Pointer to SDSTAT structure receiving data.</p></td></tr><tr><td class="CDLEntry">p1-p4</td><td class="CDLDefinition"><p>Parameters p1 to p4</p></td></tr><tr><td class="CDLEntry">crc</td><td class="CDLDefinition"><p>CRC of the command</p></td></tr><tr><td class="CDLEntry">response</td><td class="CDLDefinition"><p>Pointer to buffer receiving the card response</p></td></tr><tr><td class="CDLEntry">n</td><td class="CDLDefinition"><p>Number of response bytes</p></td></tr><tr><td class="CDLEntry">answermask</td><td class="CDLDefinition"><p>The card answer is masked with answermask before being compared with okanswer.&nbsp; When an exact answer is desired use answermask=0xff</p></td></tr><tr><td class="CDLEntry">okanswer</td><td class="CDLDefinition"><p>Expected answer in case of success after masking with answermask.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_acmd23_ns"></a><a name="Topic287"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_acmd23_ns</div>
 <div id="NDPrototype287" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_acmd23_ns(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PName last">num</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Issue ACMD23 to pre-erase blocks before multi-block writes.&nbsp; Does not select the card.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">num<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span></div></td><td class="CDLDefinition"><p>Number of sectors to pre-erase</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_block_open"></a><a name="Topic288"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_block_open</div>
 <div id="NDPrototype288" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_block_open(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PName last">addr</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Selects the card and start a single block write command at the specified address.&nbsp; This function is used for single block writes.</p><div class="CHeading">Does</div><ul><li><p>Select card</p></li><li><p>Issue a MMC_WRITE_BLOCK command</p></li><li><p>Issue a MMC_STARTBLOCK token</p></li></ul><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Start of write ok</p></td></tr><tr><td class="CDLEntry">other</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_block_close"></a><a name="Topic88"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_block_close</div>
 <div id="NDPrototype88" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_block_close(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Terminates the block write transaction and deselects the card.&nbsp; This function is used for single/multi block writes.</p><p>It is the responsability of the application to call this function after exactly one block of data has been provided.</p><div class="CHeading">Does</div><ul><li><p>Completes the block with CRC and wait for card ready</p></li><li><p>Deselects card</p></li></ul><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>End of write ok</p></td></tr><tr><td class="CDLEntry">other</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_block_stop"></a><a name="Topic89"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_block_stop</div>
 <div id="NDPrototype89" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_block_stop(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Call after 512 bytes are written to complete the block with the checksum and wait for readyness.&nbsp; Reads back the error codes.&nbsp; This function is used for single/multi block writes.</p><p>Internally it calls: - _sd_block_stop_nowait: Send CRC and check data was received - _sd_block_stop_dowait: Wait for card ready</p><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Ok</p></td></tr><tr><td class="CDLEntry">other</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_block_stop_nowait"></a><a name="Topic90"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_block_stop_nowait</div>
 <div id="NDPrototype90" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_block_stop_nowait(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Completes a block write by sending the CRC and returns; does not wait for readyness.&nbsp; This allows interleaving data processing while sdcard completes writes</p><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Ok</p></td></tr><tr><td class="CDLEntry">other</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_block_stop_dowait"></a><a name="Topic91"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_block_stop_dowait</div>
 <div id="NDPrototype91" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> _sd_block_stop_dowait(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Waits for readyness after a block write.</p><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Ok</p></td></tr><tr><td class="CDLEntry">other</td><td class="CDLDefinition"><p>Error</p></td></tr></table></div>
</div>

<a name="_sd_writebuffer"></a><a name="Topic70"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_sd_writebuffer</div>
 <div id="NDPrototype70" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> _sd_writebuffer(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="first"></td><td class="PType"><span class="SHKeyword">char</span>&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">buffer,</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">size</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Writes size bytes from buffer to card.&nbsp; This function is used for single or multiblock block writes.</p><p>It is the responsability of the caller to ensure that the number of bytes written is equal to a complete block before calling _sd_block_close.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">buffer<div class="CDLParameterType"><span class="SHKeyword">char</span>*</div></td><td class="CDLDefinition"><p>Buffer containing the data to write to the card</p></td></tr><tr><td class="CDLEntry">size<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">short</span></div></td><td class="CDLDefinition"><p>Number of bytes to write to the card</p></td></tr></table></div>
</div>

<a name="_sd_wait_notbusy"></a><a name="Topic289"></a><div class="CTopic TFunction LC last">
 <div class="CTitle">_sd_wait_notbusy</div>
 <div id="NDPrototype289" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">char</span> __sd_wait_notbusy(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PName last">timeout</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Waits until the SD card is not busy, i.e. it returns an 0xFF token.</p><p>If timeout is set to zero then timeout is disabled. However, it is recommended to set a timeout to catch potential errors.</p><p>This function assumes the SD card is selected.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">timeout<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span></div></td><td class="CDLDefinition"><p>timeout in milliseconds, or 0 if the timeout is disabled.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">0</td><td class="CDLDefinition"><p>Success</p></td></tr><tr><td class="CDLEntry">1</td><td class="CDLDefinition"><p>Failure</p></td></tr></table></div>
</div>

</body></html>