<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>wait.c</title><link rel="stylesheet" type="text/css" href="../../styles/main.css"><script type="text/javascript" src="../../styles/main.js"></script><script type="text/javascript">NDLoader.LoadJS("Content", "../../styles/");</script></head>

<!-- Generated by Natural Docs, version 2.0 (Development Release 08-22-2015) -->

<!-- saved from url=(0026)http://www.naturaldocs.org -->

<body onload="NDLoader.OnLoad('Content');" class="NDPage NDContentPage">

<a name="wait"></a><a name="Topic138"></a><div class="CTopic TFile LC first">
 <div class="CTitle">wait</div>
 <div class="CBody"><p>This library provides functions related to timing, waiting, and issuing periodic callbacks.</p><p>This library requires some of these functions to be called from a timer interrupt to update the internal logic:</p><table class="CDefinitionList"><tr><td class="CDLEntry">_tick_1024hz</td><td class="CDLDefinition"><p>This function must be called from an interrupt running at 1024Hz. _timer_tick_1024hz or _timer_tick_1000hz are mutually exclusive: it is mandatory to call one or the other, but not both.</p></td></tr><tr><td class="CDLEntry">[_tick_1000hz</td><td class="CDLDefinition"><p>This function must be called from an interrupt running at 1000Hz. _timer_tick_1024hz or _timer_tick_1000hz are mutually exclusive: it is mandatory to call one or the other, but not both.]</p></td></tr><tr><td class="CDLEntry">_timer_tick_hz</td><td class="CDLDefinition"><p>Optionally, this may be called once per second if a high-accuracy RTC with second resolution is available.</p></td></tr></table><p>The overall time is composed of the highly accurate second counter (if available), combined with the less 1024Hz timer for millisecond accuracy.</p><p>This library allows to register user callbacks to be called at regular interval from the timer interrupts with a specified clock divider.&nbsp; The callbacks are divided in millisecond-accuracy callbacks (functions timer_register_callback and timer_unregister_callback) and second-accuracy callbacks (functions timer_register_slowcallback and timer_unregister_slowcallback).&nbsp; The slow callbacks are only available if the 1Hz tick is called (_timer_tick_hz). Slow callbacks are lighter on processor usage and should be preferred for task to be executed with a longer time interval which does not need millisecond accuracy.</p><p>The functions timer_waitperiod_ms and timer_waitperiod_us allow to wait until a period of time or a multiple of the period has elapsed from the previous call.&nbsp; This can be used to schedule taks which must land on a periodic grid, such as sampling.</p><p>The key functions are:</p><ul><li><p>timer_init:						Initialise the timer subsystem with a given epoch.</p></li><li><p>timer_ms_get:						Return the time in millisecond since the epoch; time is composed of the 1Hz high accuracy clock (if available) and the internal 1000Hz or 1024Hz clock.</p></li><li><p>timer_ms_get_intclk:				Return the time in millisecond since the epoch; time is composed only of the internal 1000Hz or 1024Hz clock.</p></li><li><p>timer_us_get: 					Return the time in microsecond since the epoch.</p></li><li><p>timer_register_callback:			Register a callback that will be called at 1024Hz/(divider+1) Hz</p></li><li><p>timer_register_slowcallback:		Register a callback that will be called at 1Hz/(divider+1) Hz</p></li><li><p>timer_unregister_callback: 		Unregisters a callback</p></li><li><p>timer_unregister_slowcallback:	Unregisters a slow callback</p></li><li><p>timer_printcallbacks:				Prints the list of registered callbacks</p></li><li><p>timer_waitperiod_ms:				Wait until a a period of time - or a multiple of it - has elapsed from the previous call.</p></li><li><p>timer_waitperiod_us:				Wait untila a period of time - or a multiple of it - has elapsed from the previous call.</p></li></ul><p><b>Callbacks</b></p><p>There are two types of callbacks: &quot;normal&quot; occuring at 1KHz divided by a user-specific factor and &quot;slow&quot; occurring at 1Hz divided by a user-specific factor.</p><p>Slow callbacks are only available if _timer_tick_hz is called at 1Hz, otherwise use the normal callbacks. However, for infrequent tasks, slow callbacks are lighter on system resources.</p><p>The callbacks must be of the form unsigned char callback(unsigned char)</p><p>The return value of the callback is currently not used, but it is recommended to return 0 (future versions of the API could use the return value to deregister a callback).</p><p>The parameter passed to &quot;normal&quot; callbacks is always 0. The parameter passed to the &quot;slow&quot; callbacks is the number of seconds since the epoch, i.e.&nbsp; the number of times _timer_tick_hz has been called. This can be used to synchronise tasks based on the number of seconds elapsed since the epoch.</p></div>
</div>

<a name="Functions"></a><a name="Topic24"></a><div class="CTopic TGroup LC">
 <div class="CTitle">Functions</div>
</div>

<a name="timer_init"></a><a name="Topic25"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_init</div>
 <div id="NDPrototype25" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> timer_init(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td class="PName last">epoch_sec</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Initialise the timer subsystem with a given epoch.</p><p>The epoch is optional: set it to zero if the system does not have a battery-backed RTC.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">epoch_sec<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span></div></td><td class="CDLDefinition"><p>Time in second from an arbitrary &quot;zero time&quot;.&nbsp; If the system has an absolute time reference (e.g. a battery backed RTC) use the RTC time as the epoch, otherwise set to zero.</p></td></tr></table></div>
</div>

<a name="timer_ms_get_c"></a><a name="Topic19"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_ms_get_c</div>
 <div class="CBody"><p>Return the time in millisecond since the epoch.</p><p>The maximum time since the epoch is about 48.5 days or .&nbsp; The return value is guaranteed to be monotonic until the time counter wraps around after 48 days.</p><div class="CHeading">Returns</div><p>Time in milliseconds since the epoch</p></div>
</div>

<a name="timer_ms_get_intclk"></a><a name="Topic201"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_ms_get_intclk</div>
 <div id="NDPrototype201" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span> timer_ms_get_intclk(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Return the time in millisecond since the epoch using only the internal clock.</p><p>Unlike timer_ms_get, which uses both the internal clock and an external high-accuracy 1Hz clock, timer_ms_get_intclk only uses the internal clock.</p><p>Use this function for debugging purposes if the 1Hz clock is provided but unreliable (e.g. if a RTC time is changed).</p><p>The maximum time since the epoch is about 48.5 days.&nbsp; The return value is guaranteed to be monotonic until the time counter wraps around after 48 days.</p><div class="CHeading">Returns</div><p>Time in milliseconds since the epoch</p></div>
</div>

<a name="timer_register_callback"></a><a name="Topic27"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_register_callback</div>
 <div id="NDPrototype27" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">char</span> timer_register_callback(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned char</span>&nbsp;</td><td class="PType">(*callback)&nbsp;</td><td class="PNamePrefix">(</td><td class="PName last">unsigned char),</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">divider</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>1024Hz Register a callback that will be called at --------- Hz.&nbsp; divider+1</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">callback</td><td class="CDLDefinition"><p>User callback</p></td></tr><tr><td class="CDLEntry">divider<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">short</span></div></td><td class="CDLDefinition"><p>How often the callback must be called, i.e. 1024Hz/(divider+1) Hz.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">-1</td><td class="CDLDefinition"><p>Can't register callback</p></td></tr><tr><td class="CDLEntry">otherwise</td><td class="CDLDefinition"><p>Callback ID</p></td></tr></table></div>
</div>

<a name="timer_register_slowcallback"></a><a name="Topic28"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_register_slowcallback</div>
 <div id="NDPrototype28" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">char</span> timer_register_slowcallback(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned char</span>&nbsp;</td><td class="PType">(*callback)&nbsp;</td><td class="PNamePrefix">(</td><td class="PName last">unsigned char),</td></tr><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">divider</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>1Hz Register a callback that will be called at --------- Hz.&nbsp; divider+1</p><p>Slow callbacks are only available if the 1Hz tick is available (_timer_tick_hz), otherwise use timer_register_callback.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">callback</td><td class="CDLDefinition"><p>User callback</p></td></tr><tr><td class="CDLEntry">divider<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">short</span></div></td><td class="CDLDefinition"><p>How often the callback must be called, i.e. 1Hz/(divider+1) Hz.</p></td></tr></table><div class="CHeading">Returns</div><table class="CDefinitionList"><tr><td class="CDLEntry">-1</td><td class="CDLDefinition"><p>Can't register callback</p></td></tr><tr><td class="CDLEntry">otherwise</td><td class="CDLDefinition"><p>Callback ID</p></td></tr></table></div>
</div>

<a name="timer_unregister_callback"></a><a name="Topic29"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_unregister_callback</div>
 <div id="NDPrototype29" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> timer_unregister_callback(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned char</span>&nbsp;</td><td class="PType">(*callback)&nbsp;</td><td class="PNamePrefix">(</td><td class="PName last">unsigned char)</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Unregisters a callback.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">callback</td><td class="CDLDefinition"><p>User callback to unregister</p></td></tr></table></div>
</div>

<a name="timer_unregister_slowcallback"></a><a name="Topic30"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_unregister_slowcallback</div>
 <div id="NDPrototype30" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> timer_unregister_slowcallback(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned char</span>&nbsp;</td><td class="PType">(*callback)&nbsp;</td><td class="PNamePrefix">(</td><td class="PName last">unsigned char)</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Unregisters a slow callback.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">callback</td><td class="CDLDefinition"><p>User callback to unregister</p></td></tr></table></div>
</div>

<a name="timer_printcallbacks"></a><a name="Topic31"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_printcallbacks</div>
 <div id="NDPrototype31" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> timer_printcallbacks(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PType first">FILE&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">f</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Prints the list of registered callbacks.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">f<div class="CDLParameterType">FILE*</div></td><td class="CDLDefinition"><p>FILE on which to print the information</p></td></tr></table></div>
</div>

<a name="_tick_hz"></a><a name="Topic32"></a><div class="CTopic TFunction LC">
 <div class="CTitle">_tick_hz</div>
 <div id="NDPrototype32" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">void</span> _timer_tick_hz(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PName first last">void</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>This function may be called from a RTC interrupt at 1Hz (optional).</p><p>The underlying assumption is that this RTC 1Hz timer is more accurate than the 1024Hz timer derived from the processor clock.&nbsp; The overall time is composed of the highly accurate second counter, combined with the less 1024Hz timer for millisecond accuracy.</p></div>
</div>

<a name="timer_waitperiod_ms"></a><a name="Topic33"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_waitperiod_ms</div>
 <div id="NDPrototype33" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span> timer_waitperiod_ms(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">short</span>&nbsp;</td><td></td><td class="PName last">p,</td></tr><tr><td class="first"></td><td class="PType">WAITPERIOD&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">wp</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Wait until a a period of time, or a multiple of it, has elapsed from the previous call.</p><p>Prior to the first call to this function, wp must be set to 0.</p><p>This function is time-wraparound-safe if the desired period and maximum time elapsed between each function call is lower than 0x80000000 ms (i.e. 24 days).</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">p<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">short</span></div></td><td class="CDLDefinition"><p>Period in milliseconds</p></td></tr><tr><td class="CDLEntry">wp<div class="CDLParameterType">WAITPERIOD*</div></td><td class="CDLDefinition"><p>Pointer to WAITPERIOD, internally used to regularly schedule the waits.</p></td></tr></table><div class="CHeading">Returns</div><p>Current time in ms.</p></div>
</div>

<a name="timer_waitperiod_us"></a><a name="Topic34"></a><div class="CTopic TFunction LC">
 <div class="CTitle">timer_waitperiod_us</div>
 <div id="NDPrototype34" class="NDPrototype WideForm CStyle"><table><tr><td class="PBeforeParameters"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span> timer_waitperiod_us(</td><td class="PParametersParentCell"><table class="PParameters"><tr><td class="PModifierQualifier first"><span class="SHKeyword">unsigned</span>&nbsp;</td><td class="PType"><span class="SHKeyword">long</span>&nbsp;</td><td></td><td class="PName last">p,</td></tr><tr><td class="first"></td><td class="PType">WAITPERIOD&nbsp;</td><td class="PNamePrefix">*</td><td class="PName last">wp</td></tr></table></td><td class="PAfterParameters">)</td></tr></table></div>
 <div class="CBody"><p>Wait until a a period of time, or a multiple of it, has elapsed from the previous call.</p><p>Prior to the first call to this function, wp must be set to 0.</p><p>This function is time-wraparound-safe if the desired period and maximum time elapsed between each function call is lower than 0x80000000 us (i.e. 35 minutes).</p><p>This function returns immediately for delays lower than 50uS.&nbsp; This function may not be sufficiently accurate for delays below about 150us.</p><div class="CHeading">Parameters</div><table class="CDefinitionList"><tr><td class="CDLEntry">p<div class="CDLParameterType"><span class="SHKeyword">unsigned</span> <span class="SHKeyword">long</span></div></td><td class="CDLDefinition"><p>Period in microseconds</p></td></tr><tr><td class="CDLEntry">wp<div class="CDLParameterType">WAITPERIOD*</div></td><td class="CDLDefinition"><p>Pointer to WAITPERIOD, internally used to regularly schedule the waits.</p></td></tr></table><div class="CHeading">Returns</div><p>Current time in us.</p></div>
</div>

<a name="timer_waitperiod_us_test"></a><a name="Topic35"></a><div class="CTopic TFunction LC last">
 <div class="CTitle">timer_waitperiod_us_test</div>
 <div class="CBody"><p>Tests of timer_waitperiod_us</p></div>
</div>

</body></html>